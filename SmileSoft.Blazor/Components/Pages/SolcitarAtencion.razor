@page "/solicitar-atencion"
@using SmileSoft.API.Clients;
@using SmileSoft.DTO;
@using SmileSoft.Blazor.Components.Layout
@rendermode InteractiveServer
@inject IAuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Solicitar Atención</PageTitle>

<div class="container mt-4">
    <h3>Solicitar Atención</h3>

    @if (!string.IsNullOrEmpty(mensajeError))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @mensajeError
            <button type="button" class="btn-close" @onclick="() => mensajeError = string.Empty"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(mensajeExito))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @mensajeExito
            <button type="button" class="btn-close" @onclick="() => mensajeExito = string.Empty"></button>
        </div>
    }

    @if (cargandoDatosIniciales)
    {
        <div class="text-center my-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p>Cargando información del paciente...</p>
        </div>
    }
    else if (pacienteSeleccionado != null)
    {
        <div class="card mb-4">
            <div class="card-header">
                <h5>Datos del Paciente</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">DNI</label>
                        <input type="text" class="form-control" value="@pacienteSeleccionado.NroDni" readonly />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Nombre y Apellido</label>
                        <input type="text" class="form-control" value="@($"{pacienteSeleccionado.Nombre} {pacienteSeleccionado.Apellido}")" readonly />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Obra Social</label>
                        <input type="text" class="form-control" value="@obraSocial" readonly />
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5>Datos de la Atención</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="cmbTipoAtencion" class="form-label">Tipo de Atención</label>
                        <select class="form-select" id="cmbTipoAtencion" @bind="tipoAtencionSeleccionado" @bind:after="OnSelectionChanged">
                            <option value="0">-- Seleccione --</option>
                            @if (tiposAtencion != null)
                            {
                                @foreach (var tipo in tiposAtencion)
                                {
                                    <option value="@tipo.Id">@tipo.Descripcion (@tipo.Duracion.ToString(@"hh\:mm"))</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="cmbOdontologo" class="form-label">Odontólogo</label>
                        <select class="form-select" id="cmbOdontologo" @bind="odontologoSeleccionado" @bind:after="OnSelectionChanged">
                            <option value="0">-- Seleccione --</option>
                            @if (odontologos != null)
                            {
                                @foreach (var odo in odontologos)
                                {
                                    <option value="@odo.Id">@odo.NombreCompleto</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="dtpFecha" class="form-label">Fecha</label>
                        <input type="date" class="form-control" id="dtpFecha" @bind="fechaSeleccionada" @bind:after="OnSelectionChanged" min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                    </div>
                </div>

                @if (tipoAtencionSeleccionado > 0 && odontologoSeleccionado > 0 && fechaSeleccionada.HasValue)
                {
                    @if (cargandoHorarios)
                    {
                        <div class="text-center my-3">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Cargando horarios...</span>
                            </div>
                            <p>Buscando horarios disponibles...</p>
                        </div>
                    }
                    else
                    {
                        @if (horariosDisponibles != null && horariosDisponibles.Any())
                        {
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="cmbHorario" class="form-label">Horario Disponible</label>
                                    <select class="form-select" id="cmbHorario" @bind="horarioSeleccionado">
                                        <option value="">-- Seleccione --</option>
                                        @foreach (var horario in horariosDisponibles)
                                        {
                                            <option value="@horario">@horario</option>
                                        }
                                    </select>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-warning">
                                No hay horarios disponibles para la selección actual.
                            </div>
                        }
                    }
                }
                else if (tipoAtencionSeleccionado > 0 || odontologoSeleccionado > 0)
                {
                    <div class="alert alert-info">
                        Complete todos los campos para ver los horarios disponibles.
                    </div>
                }
            </div>
        </div>

        <div class="d-flex justify-content-between">
            <button class="btn btn-secondary" @onclick="Volver">Volver</button>
            <button class="btn btn-success" @onclick="SolicitarAtencion" disabled="@(!PuedeGuardar() || guardandoAtencion)">
                @if (guardandoAtencion)
                {
                    <span class="spinner-border spinner-border-sm me-2"></span>
                }
                Solicitar Atención
            </button>
        </div>
    }
    else
    {
        <div class="alert alert-warning">
            <h5>Acceso no autorizado</h5>
            <p>Debe iniciar sesión como paciente para solicitar una atención.</p>
            <button class="btn btn-primary" @onclick="IrALogin">Ir a Iniciar Sesión</button>
        </div>
    }
</div>

@code {
    private PacienteDTO? pacienteSeleccionado;
    private string obraSocial = string.Empty;
    private List<TipoAtencionDTO>? tiposAtencion;
    private List<OdontologoDTO>? odontologos;
    private List<AtencionDetalleDTO>? atencionesDelDia;
    private List<string>? horariosDisponibles;
    
    private int tipoAtencionSeleccionado = 0;
    private int odontologoSeleccionado = 0;
    private DateTime? fechaSeleccionada = DateTime.Today;
    private string? horarioSeleccionado;
    
    private bool cargandoDatosIniciales = true;
    private bool cargandoHorarios = false;
    private bool guardandoAtencion = false;
    
    private string mensajeError = string.Empty;
    private string mensajeExito = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            cargandoDatosIniciales = true;

            // Verificar que el usuario esté autenticado
            var isAuthenticated = await AuthService.IsAuthenticatedAsync();
            if (!isAuthenticated)
            {
                Navigation.NavigateTo("/login");
                return;
            }

            // Verificar que el usuario sea paciente
            var rol = await AuthService.GetRolAsync();
            if (!rol?.Equals("Paciente", StringComparison.OrdinalIgnoreCase) == true)
            {
                mensajeError = "Debe iniciar sesión como paciente para solicitar una atención.";
                cargandoDatosIniciales = false;
                return;
            }

            // Verificar que el usuario esté autenticado como paciente
            var pacienteId = await AuthService.GetPacienteIdAsync();
            if (!pacienteId.HasValue)
            {
                mensajeError = "Debe iniciar sesión como paciente para solicitar una atención.";
                cargandoDatosIniciales = false;
                return;
            }

            // Cargar datos del paciente autenticado
            pacienteSeleccionado = await PacienteApiClient.GetOneAsync(pacienteId.Value);
            
            if (pacienteSeleccionado == null)
            {
                mensajeError = "No se pudo cargar la información del paciente.";
                cargandoDatosIniciales = false;
                return;
            }

            // Cargar obra social
            if (pacienteSeleccionado.TipoPlanId.HasValue)
            {
                var tipoPlan = await TipoPlanApiClient.GetOneAsync(pacienteSeleccionado.TipoPlanId.Value);
                var obraSocialDTO = await ObraSocialApiClient.GetOneAsync(tipoPlan.ObraSocialId);
                obraSocial = obraSocialDTO?.Nombre ?? "Sin obra social";
            }
            else
            {
                obraSocial = "Sin obra social";
            }

            // Cargar tipos de atención
            tiposAtencion = (await TipoAtencionApiClient.GetAllAsync()).ToList();
            
            // Cargar odontólogos
            odontologos = (await OdontologoApiClient.GetAllAsync())?.ToList();
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al cargar los datos iniciales: {ex.Message}";
        }
        finally
        {
            cargandoDatosIniciales = false;
        }
    }

    private async Task OnSelectionChanged()
    {
        await BuscarHorariosDisponibles();
    }

    private async Task BuscarHorariosDisponibles()
    {
        if (tipoAtencionSeleccionado <= 0 || odontologoSeleccionado <= 0 || !fechaSeleccionada.HasValue)
        {
            atencionesDelDia = null;
            horariosDisponibles = null;
            return;
        }

        try
        {
            cargandoHorarios = true;
            mensajeError = string.Empty;
            
            // Obtener atenciones del día para el odontólogo seleccionado
            atencionesDelDia = (await AtencionApiClient.GetByFechaRangeAndOdoAsync(
                fechaSeleccionada.Value.Date, 
                fechaSeleccionada.Value.Date, 
                odontologoSeleccionado
            )).Where(a => a.Estado == "Otorgada" || a.Estado == "En sala de espera" || a.Estado == "Atendido").ToList();

            // Obtener el tipo de atención seleccionado para conocer su duración
            var tipoAtencion = tiposAtencion?.FirstOrDefault(t => t.Id == tipoAtencionSeleccionado);
            if (tipoAtencion == null) return;

            var duracionNuevoTurno = tipoAtencion.Duracion;
            var horariosTemp = new List<string>();

            // Horario de atención: 8:00 a 17:00 con intervalos de 30 minutos
            var horaInicio = TimeSpan.FromHours(8);
            var horaFin = TimeSpan.FromHours(17);
            var intervalo = TimeSpan.FromMinutes(30);

            for (var hora = horaInicio; hora < horaFin; hora = hora.Add(intervalo))
            {
                // Verificar que el turno completo quepa en el horario
                if (hora.Add(duracionNuevoTurno) > horaFin)
                {
                    break;
                }

                bool horarioOcupado = false;
                var inicioNuevoTurno = hora;
                var finNuevoTurno = hora.Add(duracionNuevoTurno);

                // Verificar si hay conflicto con alguna atención existente
                foreach (var atencionExistente in atencionesDelDia)
                {
                    var inicioTurnoExistente = atencionExistente.FechaHoraAtencion.TimeOfDay;
                    var finTurnoExistente = inicioTurnoExistente.Add(atencionExistente.TipoAtencionDuracion);

                    // Verificar solapamiento
                    if (inicioNuevoTurno < finTurnoExistente && finNuevoTurno > inicioTurnoExistente)
                    {
                        horarioOcupado = true;
                        break;
                    }
                }

                if (!horarioOcupado)
                {
                    horariosTemp.Add(hora.ToString(@"hh\:mm"));
                }
            }

            horariosDisponibles = horariosTemp;
            horarioSeleccionado = null;
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al buscar horarios disponibles: {ex.Message}";
            horariosDisponibles = null;
        }
        finally
        {
            cargandoHorarios = false;
        }
    }

    private bool PuedeGuardar()
    {
        return pacienteSeleccionado != null 
            && tipoAtencionSeleccionado > 0 
            && odontologoSeleccionado > 0 
            && fechaSeleccionada.HasValue 
            && !string.IsNullOrEmpty(horarioSeleccionado);
    }

    private async Task SolicitarAtencion()
    {
        if (!PuedeGuardar())
        {
            mensajeError = "Complete todos los campos antes de solicitar la atención.";
            return;
        }

        try
        {
            guardandoAtencion = true;
            mensajeError = string.Empty;
            mensajeExito = string.Empty;

            var fechaHora = fechaSeleccionada!.Value.Date + TimeSpan.Parse(horarioSeleccionado!);

            var atencionDTO = new AtencionDTO
            {
                PacienteId = pacienteSeleccionado!.Id,
                TipoAtencionId = tipoAtencionSeleccionado,
                OdontologoId = odontologoSeleccionado,
                FechaHoraAtencion = fechaHora
            };

            await AtencionApiClient.CreateAsync(atencionDTO);
            
            mensajeExito = "Atención solicitada correctamente.";
            
            // Esperar un momento para que el usuario vea el mensaje
            await Task.Delay(1500);
            
            // Redirigir a la página de atenciones
            Navigation.NavigateTo("/mis-atenciones");
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al solicitar la atención: {ex.Message}";
        }
        finally
        {
            guardandoAtencion = false;
        }
    }

    private void Volver()
    {
        Navigation.NavigateTo("/mis-atenciones");
    }

    private void IrALogin()
    {
        Navigation.NavigateTo("/login");
    }
}
